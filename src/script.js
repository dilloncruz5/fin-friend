// === Budget App Language Translations ===
const translations = {
  en: {
    welcome: "Welcome to",
    tagline: "Your personal guide to financial freedom",
    "select-language": "Select Language:",
    "ai-assistant": "AI Financial Assistant",
    "ai-desc": "Ask any financial questions in English, Hindi, or Tamil. Get personalized advice instantly.",
    "budget-tracker": "Budget Tracker",
    "budget-desc": "Record your income and expenses to understand your spending patterns and save more effectively.",
    "investment-guide": "Investment Guide",
    "investment-desc": "Find the best investment options based on your savings amount and financial goals.",
    "loan-eligibility": "Loan Eligibility",
    "loan-desc": "Enter your financial details to see potential loan amounts and eligibility.",
    "financial-education": "Financial Education",
    "coming-soon": "Learn more about personal finance and grow your financial knowledge. (Coming Soon)"
  },
  hi: {
    welcome: "à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤¹à¥ˆ",
    tagline: "à¤†à¤ªà¤•à¥€ à¤µà¤¿à¤¤à¥à¤¤à¥€à¤¯ à¤¸à¥à¤µà¤¤à¤‚à¤¤à¥à¤°à¤¤à¤¾ à¤•à¥‡ à¤²à¤¿à¤ à¤®à¤¾à¤°à¥à¤—à¤¦à¤°à¥à¤¶à¤•",
    "select-language": "à¤­à¤¾à¤·à¤¾ à¤šà¥à¤¨à¥‡à¤‚:",
    "ai-assistant": "à¤à¤†à¤ˆ à¤µà¤¿à¤¤à¥à¤¤à¥€à¤¯ à¤¸à¤¹à¤¾à¤¯à¤•",
    "ai-desc": "à¤…à¤‚à¤—à¥à¤°à¥‡à¤œà¤¼à¥€, à¤¹à¤¿à¤‚à¤¦à¥€ à¤¯à¤¾ à¤¤à¤®à¤¿à¤² à¤®à¥‡à¤‚ à¤…à¤ªà¤¨à¥‡ à¤µà¤¿à¤¤à¥à¤¤à¥€à¤¯ à¤ªà¥à¤°à¤¶à¥à¤¨ à¤ªà¥‚à¤›à¥‡à¤‚à¥¤ à¤¤à¥à¤°à¤‚à¤¤ à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤—à¤¤ à¤¸à¤²à¤¾à¤¹ à¤ªà¤¾à¤à¤‚à¥¤",
    "budget-tracker": "à¤¬à¤œà¤Ÿ à¤Ÿà¥à¤°à¥ˆà¤•à¤°",
    "budget-desc": "à¤…à¤ªà¤¨à¥€ à¤†à¤¯ à¤”à¤° à¤–à¤°à¥à¤š à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚ à¤¤à¤¾à¤•à¤¿ à¤†à¤ª à¤…à¤ªà¤¨à¥‡ à¤–à¤°à¥à¤š à¤•à¥‹ à¤¸à¤®à¤ à¤¸à¤•à¥‡à¤‚ à¤”à¤° à¤¬à¥‡à¤¹à¤¤à¤° à¤¬à¤šà¤¤ à¤•à¤° à¤¸à¤•à¥‡à¤‚à¥¤",
    "investment-guide": "à¤¨à¤¿à¤µà¥‡à¤¶ à¤®à¤¾à¤°à¥à¤—à¤¦à¤°à¥à¤¶à¤¿à¤•à¤¾",
    "investment-desc": "à¤…à¤ªà¤¨à¥€ à¤¬à¤šà¤¤ à¤°à¤¾à¤¶à¤¿ à¤”à¤° à¤²à¤•à¥à¤·à¥à¤¯à¥‹à¤‚ à¤•à¥‡ à¤†à¤§à¤¾à¤° à¤ªà¤° à¤¸à¤°à¥à¤µà¥‹à¤¤à¥à¤¤à¤® à¤¨à¤¿à¤µà¥‡à¤¶ à¤µà¤¿à¤•à¤²à¥à¤ª à¤ªà¤¾à¤à¤‚à¥¤",
    "loan-eligibility": "à¤‹à¤£ à¤ªà¤¾à¤¤à¥à¤°à¤¤à¤¾",
    "loan-desc": "à¤¸à¤‚à¤­à¤¾à¤µà¤¿à¤¤ à¤‹à¤£ à¤°à¤¾à¤¶à¤¿ à¤”à¤° à¤ªà¤¾à¤¤à¥à¤°à¤¤à¤¾ à¤¦à¥‡à¤–à¤¨à¥‡ à¤•à¥‡ à¤²à¤¿à¤ à¤…à¤ªà¤¨à¥€ à¤µà¤¿à¤¤à¥à¤¤à¥€à¤¯ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚à¥¤",
    "financial-education": "à¤µà¤¿à¤¤à¥à¤¤à¥€à¤¯ à¤¶à¤¿à¤•à¥à¤·à¤¾",
    "coming-soon": "à¤µà¥à¤¯à¤•à¥à¤¤à¤¿à¤—à¤¤ à¤µà¤¿à¤¤à¥à¤¤ à¤•à¥‡ à¤¬à¤¾à¤°à¥‡ à¤®à¥‡à¤‚ à¤œà¤¾à¤¨à¥‡à¤‚ à¤”à¤° à¤…à¤ªà¤¨à¤¾ à¤µà¤¿à¤¤à¥à¤¤à¥€à¤¯ à¤œà¥à¤žà¤¾à¤¨ à¤¬à¤¢à¤¼à¤¾à¤à¤‚à¥¤ (à¤œà¤²à¥à¤¦ à¤† à¤°à¤¹à¤¾ à¤¹à¥ˆ)"
  },
  ta: {
    welcome: "à®¨à®²à¯à®µà®°à®µà¯",
    tagline: "à®‰à®™à¯à®•à®³à¯ à®¨à®¿à®¤à®¿ à®šà¯à®¤à®¨à¯à®¤à®¿à®°à®¤à¯à®¤à®¿à®±à¯à®•à¯ à®¤à®©à®¿à®ªà¯à®ªà®Ÿà¯à®Ÿ à®µà®´à®¿à®•à®¾à®Ÿà¯à®Ÿà®¿",
    "select-language": "à®®à¯Šà®´à®¿à®¯à¯ˆ à®¤à¯‡à®°à¯à®¨à¯à®¤à¯†à®Ÿà¯à®•à¯à®•à®µà¯à®®à¯:",
    "ai-assistant": "à®à® à®¨à®¿à®¤à®¿ à®‰à®¤à®µà®¿à®¯à®¾à®³à®°à¯",
    "ai-desc": "à®†à®™à¯à®•à®¿à®²à®®à¯, à®‡à®¨à¯à®¤à®¿ à®…à®²à¯à®²à®¤à¯ à®¤à®®à®¿à®´à¯ à®®à¯Šà®´à®¿à®¯à®¿à®²à¯ à®‰à®™à¯à®•à®³à¯ à®¨à®¿à®¤à®¿ à®•à¯‡à®³à¯à®µà®¿à®•à®³à¯ˆ à®•à¯‡à®Ÿà¯à®•à®µà¯à®®à¯. à®¤à®©à®¿à®ªà¯à®ªà®¯à®©à¯ à®†à®²à¯‹à®šà®©à¯ˆà®¯à¯ˆ à®‰à®Ÿà®©à¯‡ à®ªà¯†à®±à¯à®™à¯à®•à®³à¯.",
    "budget-tracker": "à®šà¯†à®²à®µà¯à®•à¯ à®•à®£à¯à®•à®¾à®£à®¿à®ªà¯à®ªà®¾à®©à¯",
    "budget-desc": "à®‰à®™à¯à®•à®³à¯ à®µà®°à¯à®®à®¾à®©à®®à¯ à®®à®±à¯à®±à¯à®®à¯ à®šà¯†à®²à®µà¯à®•à®³à¯ˆ à®ªà®¤à®¿à®µà¯ à®šà¯†à®¯à¯à®¤à¯, à®‰à®™à¯à®•à®³à¯ à®šà¯†à®²à®µà¯ à®ªà®´à®•à¯à®•à®™à¯à®•à®³à¯ˆà®ªà¯ à®ªà¯à®°à®¿à®¨à¯à®¤à¯ à®•à¯Šà®³à¯à®³à®µà¯à®®à¯ à®®à®±à¯à®±à¯à®®à¯ à®šà®¿à®±à®ªà¯à®ªà®¾à®• à®šà¯‡à®®à®¿à®•à¯à®•à®µà¯à®®à¯.",
    "investment-guide": "à®®à¯à®¤à®²à¯€à®Ÿà¯à®Ÿà¯ à®µà®´à®¿à®•à®¾à®Ÿà¯à®Ÿà®¿",
    "investment-desc": "à®‰à®™à¯à®•à®³à¯ à®šà¯‡à®®à®¿à®ªà¯à®ªà¯ à®¤à¯Šà®•à¯ˆ à®®à®±à¯à®±à¯à®®à¯ à®¨à®¿à®¤à®¿ à®•à¯à®±à®¿à®•à¯à®•à¯‹à®³à¯à®•à®³à¯ˆ à®…à®Ÿà®¿à®ªà¯à®ªà®Ÿà¯ˆà®¯à®¾à®•à®•à¯ à®•à¯Šà®£à¯à®Ÿà¯ à®šà®¿à®±à®¨à¯à®¤ à®®à¯à®¤à®²à¯€à®Ÿà¯à®Ÿà¯ à®µà®¿à®°à¯à®ªà¯à®ªà®™à¯à®•à®³à¯ˆ à®•à®£à¯à®Ÿà®±à®¿à®¯à¯à®™à¯à®•à®³à¯.",
    "loan-eligibility": "à®•à®Ÿà®©à¯ à®¤à®•à¯à®¤à®¿",
    "loan-desc": "à®šà®¾à®¤à¯à®¤à®¿à®¯à®®à®¾à®© à®•à®Ÿà®©à¯ à®¤à¯Šà®•à¯ˆà®•à®³à¯ à®®à®±à¯à®±à¯à®®à¯ à®¤à®•à¯à®¤à®¿à®¯à¯ˆ à®ªà®¾à®°à¯à®•à¯à®• à®‰à®™à¯à®•à®³à¯ à®¨à®¿à®¤à®¿ à®µà®¿à®µà®°à®™à¯à®•à®³à¯ˆ à®‰à®³à¯à®³à®¿à®Ÿà¯à®™à¯à®•à®³à¯.",
    "financial-education": "à®¨à®¿à®¤à®¿ à®•à®²à¯à®µà®¿",
    "coming-soon": "à®¤à®©à®¿à®ªà¯à®ªà®Ÿà¯à®Ÿ à®¨à®¿à®¤à®¿à®¯à¯ˆà®ªà¯ à®ªà®±à¯à®±à®¿ à®®à¯‡à®²à¯à®®à¯ à®…à®±à®¿à®¨à¯à®¤à¯ à®‰à®™à¯à®•à®³à¯ à®¨à®¿à®¤à®¿ à®…à®±à®¿à®µà¯ˆà®ªà¯ à®ªà¯†à®°à¯à®•à¯à®•à®µà¯à®®à¯. (à®µà®¿à®°à¯ˆà®µà®¿à®²à¯ à®µà®°à¯à®®à¯)"
  }
};

// === Language switching logic ===
function changeLanguage(lang) {
  const elements = document.querySelectorAll("[data-i18n]");
  elements.forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (translations[lang] && translations[lang][key]) {
      el.textContent = translations[lang][key];
    }
  });
  localStorage.setItem("preferredLanguage", lang);
}

// === Navigate to another page ===
function navigate(url) {
  window.location.href = url; // Redirect to the specified page
}

// === On load ===
document.addEventListener("DOMContentLoaded", () => {
  const savedLang = localStorage.getItem("preferredLanguage") || "en";
  changeLanguage(savedLang);

  const languageSelector = document.querySelector("#language-selector");
  if (languageSelector) {
    languageSelector.innerHTML = '';
    ["en", "hi", "ta"].forEach((lang) => {
      const option = document.createElement("option");
      option.value = lang;
      option.textContent = translations[lang].welcome;
      languageSelector.appendChild(option);
    });
    languageSelector.value = savedLang;
    languageSelector.addEventListener("change", (e) => {
      changeLanguage(e.target.value);
    });
  }

  updateContent();
  initializeBudgetTracker();
  initializeInvestmentGuide();
});

// === Inject main content ===
function updateContent() {
  const contentDiv = document.getElementById("content");
  if (contentDiv) {
    contentDiv.innerHTML = `
      <h1 data-i18n="welcome"></h1>
      <p data-i18n="tagline"></p>
      <div class="ai-assistant">
        <h2 data-i18n="ai-assistant"></h2>
        <p data-i18n="ai-desc"></p>
      </div>
      <div class="budget-tracker">
        <h3 data-i18n="budget-tracker"></h3>
        <p data-i18n="budget-desc"></p>
      </div>
      <div class="investment-guide">
        <h3 data-i18n="investment-guide"></h3>
        <p data-i18n="investment-desc"></p>
      </div>
      <div class="loan-eligibility">
        <h3 data-i18n="loan-eligibility"></h3>
        <p data-i18n="loan-desc"></p>
      </div>
      <div class="financial-education">
        <h3 data-i18n="financial-education"></h3>
        <p data-i18n="coming-soon"></p>
      </div>
    `;
    changeLanguage(localStorage.getItem("preferredLanguage") || "en");
  }
}

// === Budget Tracker ===
function initializeBudgetTracker() {
  const incomeDisplay = document.getElementById("income");
  const expenseDisplay = document.getElementById("expense");
  const balanceDisplay = document.getElementById("balance");
  const typeInput = document.getElementById("type");
  const amountInput = document.getElementById("amount");
  const descriptionInput = document.getElementById("description");
  const addBtn = document.getElementById("add-btn");
  const transactionsContainer = document.getElementById("transactions");

  if (!incomeDisplay || !expenseDisplay || !balanceDisplay || !addBtn) return;

  let income = 0;
  let expenses = 0;

  addBtn.addEventListener("click", () => {
    const type = typeInput.value;
    const amount = parseFloat(amountInput.value);
    const description = descriptionInput.value.trim();

    if (isNaN(amount) || amount <= 0 || description === "") {
      alert("Please enter a valid amount and description.");
      return;
    }

    const transaction = document.createElement("div");
    transaction.classList.add("transaction");
    transaction.innerHTML = `
      <p><strong>${type === "income" ? "ðŸŸ¢" : "ðŸ”´"} â‚¹${amount}</strong> - ${description}</p>
    `;
    transactionsContainer.prepend(transaction);

    if (type === "income") {
      income += amount;
    } else {
      expenses += amount;
    }

    updateSummary();
    amountInput.value = "";
    descriptionInput.value = "";
  });

  function updateSummary() {
    incomeDisplay.textContent = `â‚¹${income}`;
    expenseDisplay.textContent = `â‚¹${expenses}`;
    balanceDisplay.textContent = `â‚¹${income - expenses}`;
  }
}

// === Investment Guide ===
function initializeInvestmentGuide() {
  const savingsAmount = document.getElementById("savingsAmount");
  const duration = document.getElementById("duration");
  const findOptionsButton = document.getElementById("findOptionsButton");
  const optionsContainer = document.getElementById("optionsContainer");
  const investmentOptions = document.getElementById("investmentOptions");

  const investmentData = [
    {
      name: "Fixed Deposit",
      rate: "6â€“7% p.a.",
      risk: "Low Risk",
      color: "bg-green-100 text-green-600"
    },
    {
      name: "Recurring Deposit",
      rate: "5.5â€“6.5% p.a.",
      risk: "Low Risk",
      color: "bg-green-100 text-green-600"
    },
    {
      name: "Gold Savings",
      rate: "8â€“12% p.a.",
      risk: "Medium Risk",
      color: "bg-yellow-100 text-yellow-600"
    },
    {
      name: "Mutual Funds (SIP)",
      rate: "10â€“15% p.a.",
      risk: "Medium Risk",
      color: "bg-yellow-100 text-yellow-600"
    }
  ];

  function validateInput() {
    const amount = parseFloat(savingsAmount.value);
    const years = parseInt(duration.value);
    const isValid = !isNaN(amount) && amount > 0 && years > 0;

    findOptionsButton.disabled = !isValid;
    findOptionsButton.className = isValid
      ? "w-full py-3 rounded-xl font-medium transition-all flex items-center justify-center space-x-2 bg-finance-blue text-white"
      : "w-full py-3 rounded-xl font-medium transition-all flex items-center justify-center space-x-2 bg-gray-100 text-gray-400";
  }

  function showOptions() {
    investmentOptions.innerHTML = "";
    investmentData.forEach(option => {
      const item = document.createElement("div");
      item.className = "p-4 bg-white shadow rounded-xl border border-gray-100";
      item.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <h4 class="font-semibold text-finance-soft-black">${option.name}</h4>
            <p class="text-sm text-finance-gray">${option.rate}</p>
          </div>
          <span class="text-sm px-3 py-1 rounded-full ${option.color}">${option.risk}</span>
        </div>
      `;
      investmentOptions.appendChild(item);
    });
    optionsContainer.classList.remove("hidden");
  }

  if (savingsAmount && duration && findOptionsButton) {
    savingsAmount.addEventListener("input", validateInput);
    duration.addEventListener("change", validateInput);
    findOptionsButton.addEventListener("click", showOptions);
  }
}

// === AI Chat with Markdown Support ===
const form = document.getElementById("chat-form");
const userInput = document.getElementById("user-input");
const chatbox = document.getElementById("chatbox");

if (form && userInput && chatbox) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = userInput.value.trim();
    if (!message) return;

    chatbox.innerHTML += `<div class="user-msg"><strong>You:</strong> ${message}</div>`;
    chatbox.scrollTop = chatbox.scrollHeight;
    userInput.value = "";

    try {
      const response = await fetch("http://localhost:8000/chat", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message })
      });

      const data = await response.json();
      const reply = data.response;

      const parsedReply = marked.parse(reply); // Markdown support
      chatbox.innerHTML += `<div class="bot-msg"><strong>Bot:</strong> ${parsedReply}</div>`;
      chatbox.scrollTop = chatbox.scrollHeight;
    } catch (err) {
      chatbox.innerHTML += `<div class="bot-msg"><strong>Bot:</strong> Error connecting to server.</div>`;
    }
  });
}
